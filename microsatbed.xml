<tool name="STR to bed" id="microsatbed" version="1.3.0" profile="22.05">
  <description>Short Tandem Repeats to bed features from fasta</description>
  <requirements>
    <requirement version="3.12.3" type="package">python</requirement>
    <requirement version="2.1.0" type="package">pyfastx</requirement>
    <requirement version="1.3.0" type="package">pytrf</requirement>
  </requirements>
   <required_files>
      <include path="find_str.py"/>
  </required_files>
   <version_command><![CDATA[python -c "import pytrf; from importlib.metadata import version; print(version('pytrf'))"]]></version_command>
  <command><![CDATA[python '${__tool_directory__}/find_str.py'
--fasta '${reference_genome.fasta}' 
--bed '$bed'
#if $mode_cond.mode == "SPECIFIC":
 --specific '$mode_cond.specific'
 --minreps '$mode_cond.minreps'
#else:
  #if "MONO" in $mode_cond.subset:
  --mono
  #end if
  #if "DI" in $mode_cond.subset:
  --di
  #end if
  #if "TRI" in $mode_cond.subset:
  --tri
  #end if
  #if "TETRA" in $mode_cond.subset:
  --tetra
  #end if
  #if "PENTA" in $mode_cond.subset:
  --penta
  #end if
  #if "HEXA" in $mode_cond.subset:
  --hexa
  #end if
  --monomin '$mode_cond.monomin'
  --dimin '$mode_cond.dimin'
  --trimin '$mode_cond.trimin'
  --tetramin '$mode_cond.tetramin'
  --pentamin '$mode_cond.pentamin'
  --hexamin '$mode_cond.hexamin'
#end if
]]></command>
  <inputs>
    <conditional name="reference_genome">
        <param name="genome_type_select" type="select" label="Select a source for fasta sequences to be searched for STRs" help="Options are to choose a built-in genome, or choose any history fasta file">
            <option value="indexed">Use a Galaxy server built-in reference genome fasta</option>
            <option selected="True" value="history">Use any fasta file from the current history</option>
        </param>
        <when value="indexed">
            <param name="fasta" type="select" optional="false" multiple="false" label="Choose a built-in, or custom reference genome" 
                help="If the genome you need is not on the list, add a custom genome or choose a genome fasta from the current history">
                <options from_data_table="all_fasta">
                    <filter column="2" type="sort_by"/>
                    <validator message="No genomes are available" type="no_options"/>
                </options>
            </param>
        </when>
        <when value="history">
            <param name="fasta" type="data" format="fasta" optional="false" multiple="false" label="Choose a fasta file from the current history"/>
        </when>
    </conditional>
    <conditional name="mode_cond">
    <param name="mode" type="select" label="Select patterns by motif length; or provide a specific motif pattern to report?" help="Choose *By length:* or *By pattern:* to configure STR selection mode">
      <option selected="True" value="ALL">By length: Report all motifs of one or more specified lengths (1-6nt) as bed features</option>
      <option value="SPECIFIC">By motif: Report one or more specific motifs (such as TCA,GC) as bed features</option>
    </param>
    <when value="ALL">
      <param name="subset" type="select" multiple="true" optional="false" label="Select at least 1 specific motif length to report" 
        help="Bed features will be output for every motif of the selected length(s) with the minimum required repeats or more">
        <option value="DI" selected="true">All dimers (AC,AG,AT,...)</option>
        <option value="TRI">All trimers (ACG,..)</option>
        <option value="TETRA">All tetramers (ACGT,..)</option>
        <option value="PENTA">All pentamers (ACGTC,..)</option>
        <option value="HEXA">All hexamers (ACGTCG,..)</option>
        <option value="MONO">All monomers (A,C...). Warning! Can produce overwhelming numbers of bed features</option>
      </param>
      <param name="dimin" type="integer" value="2" min="1" label="Minimum number of repeats of each dimer motif to report"/>
      <param name="trimin" type="integer" value="2" min="1" label="Minimum number of repeats of each trimer motif to report"/>
      <param name="tetramin" type="integer" value="2" min="1" label="Minimum number of repeats of each tetramer motif to report"/>
      <param name="pentamin" type="integer" value="2" min="1" label="Minimum number of repeats of each pentamer motif to report"/>
      <param name="hexamin" type="integer" value="2" min="1" label="Minimum number of repeats of each hexamer motif to report"/>
      <param name="monomin" type="integer" value="2" min="2" label="Minimum number of repeats of each monomer motif to report" 
        help="WARNING: Monomers must have minimum repeats of 2. Otherwise every single nucleotide would be reported as a feature! To prevent this, 2 is the minimum required for a repeat"/>
    </when>
    <when value="SPECIFIC">
      <param name="specific" type="text" label="Supply a specific motif pattern. Separate multiple patterns with commas such as GA,GC" 
         help="Make bed features only for the nominated specific motifs." optional="false"/>
      <param name="minreps" type="integer" value="2" min="1" label="Minimum number of repeats of each of these motifs to report" 
        help="Short tandem repeats require 2 or more consecutive motifs by definition. WARNING: If monomers are included, every single matching base will be reported as a STR if minimum repeats = 1!"
        optional="false"/>
    </when>
    </conditional>
  </inputs>
  <outputs>
    <data name="bed" format="bed" label="STR from $fasta.element_identifier" hidden="false"/>
  </outputs>
  <tests>
    <test expect_num_outputs="1">
      <conditional name="reference_genome">
          <param name="genome_type_select" value="history"/>
          <param name="fasta" value="humsamp.fa"/>
      </conditional>
      <conditional name="mode_cond">
          <param name="mode" value="ALL"/>
          <param name="subset" value="DI,TRI,TETRA,PENTA,HEXA"/>
          <param name="dimin" value="2"/>
          <param name="trimin" value="2"/>
          <param name="tetramin" value="2"/>
          <param name="pentamin" value="2"/>
          <param name="hexamin" value="2"/>
      </conditional>
      <output name="bed" value="bed_sample" compare="diff" lines_diff="0"/>
    </test>    
    <test expect_num_outputs="1">
      <conditional name="reference_genome">
          <param name="genome_type_select" value="history"/>
          <param name="fasta" value="humsamp.fa"/>
      </conditional>
      <conditional name="mode_cond">
          <param name="mode" value="SPECIFIC"/>
          <param name="specific" value="GC"/>
          <param name="minreps" value="2"/>
      </conditional>
      <output name="bed" value="dibed_sample" compare="diff" lines_diff="0"/>
    </test>
  </tests>
  <help><![CDATA[

 **Convert short repetitive sequences to bed features**

 Microsatellites are classified by their pattern or *motif* and by the number of times that pattern is repeated in an unbroken sequence.
 A microsatellite *motif* can be any distinct pattern of nucleotides, from 1 to 6nt in length.
 
 Features selected from the fasta sequence file will be combined into a single bed track, suitable for viewing in a genome browser such as JBrowse2.

 All motifs of selected lengths can be reported as individual features in the output bed file, or specific motifs can be provided and all 
 others will be ignored. In all cases, a minimum required number of repeats can be specified. 
 
 For example, requiring 2 or more repeats of the trimer *ACG* will report every sequence of *ACGACG* or *ACGACGACG* or *ACGACGACGACG* and so on, as individual bed features.
 Similarly, requiring 3 repeats of any trimer will report every distinct 3 nucleotide pattern, including *ACGACGACG* as well as every other unique 3 nucleotide pattern with 3 
 sequential repeats or more such, as "CTCCTCCTC*.

 A fasta file must be supplied for processing. A built in genome can be selected, or a fasta file of any kind can be selected from the current history. Note that all 
 symbols are treated as valid nucleotides by pytrf, so extraneous characters such as *-* or *N* in the input fasta may appear as unexpected bed features. Lower case fasta symbols will be converted
 to uppercase, to prevent them being reported as distinct motifs.


 **Filtering motifs by length**
 
 The default tool form setting is to select all dimer motif patterns. 
 
 Additional motif lengths from 1 to 6nt can be selected in the multiple-select drop-down list. All features will be returned in a single bed file. For each selected motif length, 
 the minimum number of repeats required for reporting can be adjusted. **Tandem repeats** are defined as at least 2 of any pattern. This tool allows singleton motifs to be reported,
 so is not restricted to short tandem repeats (STR)

 **Filtering motifs by pattern**

 This option allows a motif pattern to be specified as a text string such as *CG* or *ATC*. Multiple motifs can be specified as a comma separated string such as *CG,ATC*.
 All features will be returned as a single bed file.

 The minimum number of repeats for all motifs can be set to match specific requirements.

 For example, technical sequencing read bias may be influenced by the density of specific dimers, whether they are repeated or not
 such as in https://github.com/arangrhie/T2T-Polish/tree/master/pattern
 
 **Built using pytrf**

 See https://pytrf.readthedocs.io/en/latest/ for the pytrf documentation, quoted here:

   *A Tandem repeat (TR) in genomic sequence is a set of adjacent short DNA sequence repeated consecutively. The core sequence or repeat unit is generally called motif. 
   According to the motif length, tandem repeats can be classified as microsatellites and minisatellites. Microsatellites are also known as simple sequence repeats (SSRs) 
   or short tandem repeats (STRs) with motif length of 1-6 bp. Minisatellites are also sometimes referred to as variable number of tandem repeats (VNTRs) has longer motif length than microsatellites.
   Pytrf is a lightweight Python C extension for identification of tandem repeats. The pytrf enables to fastly identify both exact or perfect SSRs.
   It also can find generic tandem repeats with any size of motif, such as with maximum motif length of 100 bp. Additionally, it has capability of finding approximate or imperfect tandem repeats*
 
  ]]></help>
  <citations>
    <citation type="bibtex">@misc{pytrf,
  title = {{pytrf} Short tandem repeat finder, Accessed on July 10 2024},
  howpublished = {\url{https://github.com/lmdu/pytrf}},
  note = {Accessed on July 10 2024}
}</citation>
  </citations>
</tool>

